<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>가장 빠르게 FastAPI를 돌려보자 - uvicorn-gunicorn-fastapi-docker | Daily Log</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicons/favicon-16x16.png">
    <link rel="shortcut icon" href="../assets/favicons/favicon.ico">
    <link rel="alternate" type="application/rss+xml" href="https://jiyeonseo.github.io/rss.xml" title="Daily Log RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://jiyeonseo.github.io/feed.atom" title="Daily Log Atom Feed">
    <link rel="alternate" type="application/json" href="https://jiyeonseo.github.io/feed.json" title="Daily Log JSON Feed">
    <meta name="description" content="

FastAPI 관련 라이브러리나 예제 코드들을 살펴보다보면 실행 Dockerfile 파일이 아래와 같이 시작하는 파일들을 많이 만나볼 수 있다.

FROM tiangolo/uvicorn-gunicorn-fastapi

FastAPI를 사용한다면 tiangolo 이름부터 아주 익숙할 것이다. 맞다. 바로 FastAPI를 ...">
    
    <link rel="preload" href="/assets/css/0.styles.d9e965bb.css" as="style"><link rel="preload" href="/assets/js/app.ca882463.js" as="script"><link rel="preload" href="/assets/js/4.d48376ce.js" as="script"><link rel="preload" href="/assets/js/1.a7328d07.js" as="script"><link rel="preload" href="/assets/js/115.013a015b.js" as="script"><link rel="prefetch" href="/assets/js/100.20349d4f.js"><link rel="prefetch" href="/assets/js/101.337c7ac5.js"><link rel="prefetch" href="/assets/js/102.df0c3b4c.js"><link rel="prefetch" href="/assets/js/103.9ab2bce5.js"><link rel="prefetch" href="/assets/js/104.a8cfe2ac.js"><link rel="prefetch" href="/assets/js/105.fbf41c7d.js"><link rel="prefetch" href="/assets/js/106.137693c5.js"><link rel="prefetch" href="/assets/js/107.7b67094d.js"><link rel="prefetch" href="/assets/js/108.9c79596c.js"><link rel="prefetch" href="/assets/js/109.8f827ec6.js"><link rel="prefetch" href="/assets/js/11.266ec168.js"><link rel="prefetch" href="/assets/js/110.d3557852.js"><link rel="prefetch" href="/assets/js/111.037463d3.js"><link rel="prefetch" href="/assets/js/112.71dfe16b.js"><link rel="prefetch" href="/assets/js/113.98586e30.js"><link rel="prefetch" href="/assets/js/114.b61c2291.js"><link rel="prefetch" href="/assets/js/116.1b44155e.js"><link rel="prefetch" href="/assets/js/117.ba320cb6.js"><link rel="prefetch" href="/assets/js/118.bce8c1cf.js"><link rel="prefetch" href="/assets/js/119.4cfe496d.js"><link rel="prefetch" href="/assets/js/12.8f3a6060.js"><link rel="prefetch" href="/assets/js/120.df3465f8.js"><link rel="prefetch" href="/assets/js/121.2ab0ab3e.js"><link rel="prefetch" href="/assets/js/122.e84ca54f.js"><link rel="prefetch" href="/assets/js/123.c7c4409a.js"><link rel="prefetch" href="/assets/js/124.07b6783e.js"><link rel="prefetch" href="/assets/js/125.b1701c7a.js"><link rel="prefetch" href="/assets/js/126.0d92253e.js"><link rel="prefetch" href="/assets/js/127.007a575d.js"><link rel="prefetch" href="/assets/js/13.9ff4ae05.js"><link rel="prefetch" href="/assets/js/14.215024b0.js"><link rel="prefetch" href="/assets/js/15.0ff47d16.js"><link rel="prefetch" href="/assets/js/16.37e6c0ed.js"><link rel="prefetch" href="/assets/js/17.cbba4f66.js"><link rel="prefetch" href="/assets/js/18.b7e71dfe.js"><link rel="prefetch" href="/assets/js/19.c4464fe9.js"><link rel="prefetch" href="/assets/js/2.f8783da8.js"><link rel="prefetch" href="/assets/js/20.2dc08191.js"><link rel="prefetch" href="/assets/js/21.ff5f7b06.js"><link rel="prefetch" href="/assets/js/22.661f2a84.js"><link rel="prefetch" href="/assets/js/23.cf29033a.js"><link rel="prefetch" href="/assets/js/24.dd6f5bc6.js"><link rel="prefetch" href="/assets/js/25.9d7bdc46.js"><link rel="prefetch" href="/assets/js/26.3b8d6e0b.js"><link rel="prefetch" href="/assets/js/27.80928391.js"><link rel="prefetch" href="/assets/js/28.58a77b17.js"><link rel="prefetch" href="/assets/js/29.7f8113cb.js"><link rel="prefetch" href="/assets/js/3.487971c8.js"><link rel="prefetch" href="/assets/js/30.48f0ed8a.js"><link rel="prefetch" href="/assets/js/31.832b04d7.js"><link rel="prefetch" href="/assets/js/32.f05f003a.js"><link rel="prefetch" href="/assets/js/33.f9295acc.js"><link rel="prefetch" href="/assets/js/34.a80db534.js"><link rel="prefetch" href="/assets/js/35.abe84c23.js"><link rel="prefetch" href="/assets/js/36.4edabe0d.js"><link rel="prefetch" href="/assets/js/37.e7cfc869.js"><link rel="prefetch" href="/assets/js/38.aa1064e1.js"><link rel="prefetch" href="/assets/js/39.06859e09.js"><link rel="prefetch" href="/assets/js/40.7969b128.js"><link rel="prefetch" href="/assets/js/41.7daa36db.js"><link rel="prefetch" href="/assets/js/42.0b1c5b61.js"><link rel="prefetch" href="/assets/js/43.e741fcb4.js"><link rel="prefetch" href="/assets/js/44.212dc972.js"><link rel="prefetch" href="/assets/js/45.c68048f8.js"><link rel="prefetch" href="/assets/js/46.114afb81.js"><link rel="prefetch" href="/assets/js/47.862c6e14.js"><link rel="prefetch" href="/assets/js/48.c9b2f074.js"><link rel="prefetch" href="/assets/js/49.e7114482.js"><link rel="prefetch" href="/assets/js/5.bcd1442f.js"><link rel="prefetch" href="/assets/js/50.f467528a.js"><link rel="prefetch" href="/assets/js/51.f821ca96.js"><link rel="prefetch" href="/assets/js/52.649435a5.js"><link rel="prefetch" href="/assets/js/53.5b8dc67a.js"><link rel="prefetch" href="/assets/js/54.a0ca167c.js"><link rel="prefetch" href="/assets/js/55.3c3380f0.js"><link rel="prefetch" href="/assets/js/56.18549872.js"><link rel="prefetch" href="/assets/js/57.e19ed683.js"><link rel="prefetch" href="/assets/js/58.79fe55f7.js"><link rel="prefetch" href="/assets/js/59.4db8e029.js"><link rel="prefetch" href="/assets/js/6.49ca5872.js"><link rel="prefetch" href="/assets/js/60.9abd3c2e.js"><link rel="prefetch" href="/assets/js/61.e63ac9bb.js"><link rel="prefetch" href="/assets/js/62.6e924a53.js"><link rel="prefetch" href="/assets/js/63.9f33542a.js"><link rel="prefetch" href="/assets/js/64.38c313d2.js"><link rel="prefetch" href="/assets/js/65.fcfcf532.js"><link rel="prefetch" href="/assets/js/66.5012f3db.js"><link rel="prefetch" href="/assets/js/67.5b57b6b4.js"><link rel="prefetch" href="/assets/js/68.d99d5845.js"><link rel="prefetch" href="/assets/js/69.8107e489.js"><link rel="prefetch" href="/assets/js/7.a66f6791.js"><link rel="prefetch" href="/assets/js/70.27161263.js"><link rel="prefetch" href="/assets/js/71.761b94a6.js"><link rel="prefetch" href="/assets/js/72.531ebc5e.js"><link rel="prefetch" href="/assets/js/73.2c4b9c38.js"><link rel="prefetch" href="/assets/js/74.f50e9025.js"><link rel="prefetch" href="/assets/js/75.95a579c0.js"><link rel="prefetch" href="/assets/js/76.54cac59a.js"><link rel="prefetch" href="/assets/js/77.43aab426.js"><link rel="prefetch" href="/assets/js/78.f19c6ed1.js"><link rel="prefetch" href="/assets/js/79.5758ad17.js"><link rel="prefetch" href="/assets/js/8.b2bf099e.js"><link rel="prefetch" href="/assets/js/80.9a393ba1.js"><link rel="prefetch" href="/assets/js/81.53c49996.js"><link rel="prefetch" href="/assets/js/82.b94db98b.js"><link rel="prefetch" href="/assets/js/83.44f7bcdf.js"><link rel="prefetch" href="/assets/js/84.38740eee.js"><link rel="prefetch" href="/assets/js/85.75d98f53.js"><link rel="prefetch" href="/assets/js/86.cbe5c682.js"><link rel="prefetch" href="/assets/js/87.91edfd8c.js"><link rel="prefetch" href="/assets/js/88.a414f2e3.js"><link rel="prefetch" href="/assets/js/89.a0e02dc8.js"><link rel="prefetch" href="/assets/js/90.8df0fa19.js"><link rel="prefetch" href="/assets/js/91.30c58ca2.js"><link rel="prefetch" href="/assets/js/92.41dc4428.js"><link rel="prefetch" href="/assets/js/93.4dac8c5f.js"><link rel="prefetch" href="/assets/js/94.6f998976.js"><link rel="prefetch" href="/assets/js/95.fa78735e.js"><link rel="prefetch" href="/assets/js/96.46ebbc99.js"><link rel="prefetch" href="/assets/js/97.b91d70bf.js"><link rel="prefetch" href="/assets/js/98.08cf1b1d.js"><link rel="prefetch" href="/assets/js/99.f184a890.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.b53dac77.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9e965bb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Daily Log </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="/about.html" class="nav-link">About Me</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Daily Log </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="/about.html" class="nav-link">About Me</a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2022-10-24T00:00:00.000Z">
      2022-10-24
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/fastapi" data-v-42ccfcd5><span data-v-42ccfcd5>fastapi</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/docker" data-v-42ccfcd5><span data-v-42ccfcd5>docker</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="가장-빠르게-fastapi를-돌려보자-uvicorn-gunicorn-fastapi-docker"><a href="#가장-빠르게-fastapi를-돌려보자-uvicorn-gunicorn-fastapi-docker" class="header-anchor">#</a> 가장 빠르게 FastAPI를 돌려보자 - uvicorn-gunicorn-fastapi-docker</h1> <p>FastAPI 관련 라이브러리나 예제 코드들을 살펴보다보면 실행 Dockerfile 파일이 아래와 같이 시작하는 파일들을 많이 만나볼 수 있다.</p> <div class="language-Dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> tiangolo/uvicorn-gunicorn-fastapi</span>
</code></pre></div><p>FastAPI를 사용한다면 tiangolo 이름부터 아주 익숙할 것이다. 맞다. 바로 FastAPI를 만든 <a href="https://github.com/tiangolo" target="_blank" rel="noopener noreferrer">Sebastián Ramírez<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>가 FastAPI용 base docker image다. Python 3.6 이상의 버전들을 모두 제공하고 있으며 <code>-slim</code> (ex. <code>python3.8-slim</code>) 과 같이 Alpine Linux 버전 역시 제공하고 있으니 뭘 좋아하든 골라 사용하기 좋다.</p> <ul><li><strong>GitHub repo</strong>: <a href="https://github.com/tiangolo/uvicorn-gunicorn-fastapi-docker" target="_blank" rel="noopener noreferrer">https://github.com/tiangolo/uvicorn-gunicorn-fastapi-docker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><strong>Docker Hub image</strong>: <a href="https://hub.docker.com/r/tiangolo/uvicorn-gunicorn-fastapi/" target="_blank" rel="noopener noreferrer">https://hub.docker.com/r/tiangolo/uvicorn-gunicorn-fastapi/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>아마 FastAPI를 한번이라도 사용해 본 사람이라면 이미 <code>uvicorn main:app --reload</code> 시작이 아마 익숙할 것이다. 이 베이스 이미지에서는 여기서 하나 더 추가 되었다.</p> <ul><li><a href="https://www.uvicorn.org/" target="_blank" rel="noopener noreferrer">Uvicorn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> : lightning-fast &quot;ASGI&quot; server. 비동기 파이썬 웹 서버. 단일 process.</li> <li><a href="https://gunicorn.org/" target="_blank" rel="noopener noreferrer">Gunicorn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> : WSGI(Web Server Gateway Interface). 여기서는 여러 Uvicorn 워커 프로세스를 매니지하는 용도로 사용된다.</li></ul> <p>Uvicorn + Gunicorn 로 서버 리소스(CPU 코어 갯수)에 적합한 워커 구성을 해주며 FastAPI가 바로 사용할 수 있는 Base Image가 바로 &quot;uvicorn-gunicorn-fastapi-docker&quot; 이다.</p> <h2 id="쓰면-좋은-경우"><a href="#쓰면-좋은-경우" class="header-anchor">#</a> 쓰면 좋은 경우</h2> <ul><li>프로세스 수 조정을 크게 신경 쓰지 않아도 되는 간단한 앱.</li> <li>클러스터가 아닌 단일 서버에서 실행하는 경우.</li> <li>단일 서버에 Docker Compose로 배포하여 컨테이너 내에서 Gunicorn + Uvicorn 조합으로 사용하는 경우.</li> <li>프로메테우스와 같은 모니터링 메트릭을 가져오는 경우, 하나의 컨테이너 + 여러 프로세스 조합으로 한번에 사용하는게 간단할 수 있음.</li></ul> <h2 id="안-써도-되는-경우-prod-배포의-경우"><a href="#안-써도-되는-경우-prod-배포의-경우" class="header-anchor">#</a> 안 써도 되는 경우 (Prod 배포의 경우)</h2> <p>위에서 언급한 바와 같이 편하게 사용하라고 만든 것임으로 꼭 써야하는 것은 아니다. 오히려, 해당 Repo REAME에서부터 <strong>WARNING</strong> 까지 붙혀가며, 꼭 써야하는 것은 아니니 유의 당부를 하고 있다. &quot;그냥 직접 만들어 쓰는게 오히려 나을 수도 있다.&quot; 라고 말하고 있는데, 그 큰 이유중의 하나는 worker의 수 때문이다.</p> <p><code>uvicorn-gunicorn-fastapi-docker</code> 는 <a href="https://github.com/tiangolo/uvicorn-gunicorn-docker/blob/master/docker-images/gunicorn_conf.py#L21-L30" target="_blank" rel="noopener noreferrer">내부적으로 자동으로 process와 worker 수를 자동으로 조절해주고 있다.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  CPU 자원 상태를 체크하고 이에 알맞는 값을 계산해준다. 위에서 말한 &quot;쓰면 좋은 경우&quot;에서 반복되는 단일 서버나 단일 컨테이너로 띄울 때 좋은 이유가 여기에 있다. 떠 있는 환경에서 가장 적합한 갯수를 알아서 계산해 줄 테니 우리는 비지니스 로직에만 신경쓰면 된다.</p> <p>하지만 리얼 월드에서는 이 자동 튜닝 부분이 적합하지 않을 수도 있다. Docker를 사용하게 되면 단일로 띄우기 보다는 Kubernetes와 같은 컨테이너 오케스트레이션을 이용하여 클러스터에 여러개의 Pod으로 띄우는 경우가 대다수다. 즉, 클러스터 레벨에서 몇 개의 앱을 띄울 것인가가 관리된다. 이 때 각각의 컨테이너 내에서 Gunicorn + Uvicorn 으로 여러 워커 + 프로세스 매니저를 사용할 경우, 이 리소스 관리가 아주 복잡해 질 수 있다.</p> <p>따라서, 클러스터를 이용한 배포 및 운영을 하고 있다면 단일 Uvicorn process를 사용하는 것을 권장하고 있다. <a href="https://fastapi.tiangolo.com/deployment/docker/#replication-number-of-processes" target="_blank" rel="noopener noreferrer">더 자세한 내용은 공식 문서<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>에서도 찾아 볼 수 있다.</p> <p>이 경우 아래와 같이 기본 python 이미지를 사용하고, <code>uvicorn</code> 만을 사용하여 서버를 띄우면 된다.</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /code</span>

<span class="token instruction"><span class="token keyword">COPY</span> ./requirements.txt /code/requirements.txt</span>

<span class="token instruction"><span class="token keyword">RUN</span> pip install --no-cache-dir --upgrade -r /code/requirements.txt</span>

<span class="token comment"># Copy the main.py file to the /code directory directly (without any ./app directory).</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./main.py /code/</span>

<span class="token comment"># Run Uvicorn and tell it to import the app object from main (instead of importing from app.main).</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;uvicorn&quot;</span>, <span class="token string">&quot;main:app&quot;</span>, <span class="token string">&quot;--host&quot;</span>, <span class="token string">&quot;0.0.0.0&quot;</span>, <span class="token string">&quot;--port&quot;</span>, <span class="token string">&quot;80&quot;</span>]</span>
</code></pre></div><h2 id="사용-방법"><a href="#사용-방법" class="header-anchor">#</a> 사용 방법</h2> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> tiangolo/uvicorn-gunicorn:python3.9</span>

<span class="token instruction"><span class="token keyword">COPY</span> ./requirements.txt /app/requirements.txt</span>

<span class="token instruction"><span class="token keyword">RUN</span> pip install --no-cache-dir --upgrade -r /app/requirements.txt</span>

<span class="token instruction"><span class="token keyword">COPY</span> ./app /app</span>
</code></pre></div><p>위 경우 <code>/app/app/main.py</code> 혹은 <code>/app/main.py</code> 에 있는 <code>app</code>을 실행하게 되니 파일 위치를 유의하자.
그 다음 docker build 그리고 run 해준다.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> build <span class="token parameter variable">-t</span> myimage ./
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> mycontainer <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 myimage
</code></pre></div><p>제대로 잘 떳다면 <a href="http://localhost:8080" target="_blank" rel="noopener noreferrer">http://localhost:8080<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 에 접속될 것이다.</p> <p>만약 패키지 관리툴 Poetry를 사용한다면 아래와 같이 Poetry 설치 및 패키지 설치를 해주면 된다.</p> <div class="language-Dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> tiangolo/uvicorn-gunicorn-fastapi:python3.8</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token comment"># Install Poetry</span>
<span class="token instruction"><span class="token keyword">RUN</span> curl -sSL https://install.python-poetry.org | POETRY_HOME=/opt/poetry python &amp;&amp; <span class="token operator">\</span>
    cd /usr/local/bin &amp;&amp; <span class="token operator">\</span>
        ln -s /opt/poetry/bin/poetry &amp;&amp; <span class="token operator">\</span>
            poetry config virtualenvs.create false</span>

<span class="token instruction"><span class="token keyword">COPY</span> ./pyproject.toml ./poetry.lock* /app/</span>

<span class="token instruction"><span class="token keyword">RUN</span> bash -c <span class="token string">&quot;poetry install --no-root&quot;</span></span>

<span class="token instruction"><span class="token keyword">COPY</span> ./app /app</span>
</code></pre></div><h3 id="다른-dependency들과-함께-docker-compose로-실행하기"><a href="#다른-dependency들과-함께-docker-compose로-실행하기" class="header-anchor">#</a> 다른 dependency들과 함께 Docker Compose로 실행하기</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token key atrule">redis</span><span class="token punctuation">:</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> redislabs/redismod
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token string">&quot;16379:6379&quot;</span>
        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> $PWD/data<span class="token punctuation">:</span>/data
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>dir /data <span class="token punctuation">-</span><span class="token punctuation">-</span>loadmodule /usr/lib/redis/modules/redistimeseries.so

    <span class="token key atrule">app</span><span class="token punctuation">:</span>
        <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
        <span class="token key atrule">build</span><span class="token punctuation">:</span> .
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;8080:80&quot;</span>
        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> $PWD/app<span class="token punctuation">:</span>/app
        <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> redis
        <span class="token key atrule">command</span><span class="token punctuation">:</span> /start<span class="token punctuation">-</span>reload.sh
</code></pre></div><p>Default는 <a href="https://github.com/tiangolo/uvicorn-gunicorn-docker/blob/master/docker-images/start.sh" target="_blank" rel="noopener noreferrer">start.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>로 바로 run 되는 것으로 되어있으나, 개발 할때는  <a href="https://github.com/tiangolo/uvicorn-gunicorn-docker/blob/master/docker-images/start-reload.sh" target="_blank" rel="noopener noreferrer"><code>start-reload.sh</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>을 사용하여 코드 변경이 있을 때 마다 자동으로 리로드 될 수 있도록 하는 것이 편하다. 만약 위처럼 docker-compose가 아닌 그냥 <code>docker run</code> 사용시에는 아래와 같이 사용하면 된다.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">-v</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/app myimage /start-reload.sh
</code></pre></div><ul><li>(주의) reload에서는 Gunicorn으로 뜨지않기 때문에 만일 custom gunicorn 설정 파일을 사용한다면, reload에서는 반영되지 않는다.</li></ul> <h2 id="환경변수"><a href="#환경변수" class="header-anchor">#</a> 환경변수</h2> <p>기본적인 것들을 많이 제공하면서도 커스텀하게 필요한 부분들도 환경변수로 적절히 넣어줄 수 있다. 코드 폴더 구성이 다르거나, 워커의 수만 변경하고 싶을때, 최대 워커 수를 고정 시키고 싶은 경우 등.</p> <ul><li><code>APP_MODULE</code></li> <li><code>VARIABLE_NAME</code></li> <li><code>APP_MODULE</code></li> <li><code>GUNICORN_CONF</code></li> <li><code>WORKERS_PER_CORE</code></li> <li><code>MAX_WORKERS</code></li> <li><code>WEB_CONCURRENCY</code></li> <li><code>HOST</code></li> <li><code>PORT</code></li> <li><code>BIND</code></li> <li><code>LOG_LEVEL</code></li> <li><code>WORKER_CLASS</code></li> <li><code>TIMEOUT</code></li> <li><code>KEEP_ALIVE</code></li> <li><code>GRACEFUL_TIMEOUT</code></li> <li><code>ACCESS_LOG</code></li> <li><code>ERROR_LOG</code></li> <li><code>GUNICORN_CMD_ARGS</code></li> <li><code>PRE_START_PATH</code></li></ul> <p>자세한 사용 방법은 <a href="https://github.com/tiangolo/uvicorn-gunicorn-docker#environment-variables" target="_blank" rel="noopener noreferrer">여기<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>서 확인해 볼 수 있다.</p> <h2 id="custom-gunicorn-설정-파일"><a href="#custom-gunicorn-설정-파일" class="header-anchor">#</a> Custom Gunicorn 설정 파일</h2> <p><a href="https://github.com/tiangolo/uvicorn-gunicorn-docker/blob/master/docker-images/gunicorn_conf.py" target="_blank" rel="noopener noreferrer">기본으로 설정된 Gunicorn 파일이 있다.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 다음과 같은 path에 추가하면 override 되니 필요한 부분이 있으면 커스터마이즈도 가능하다.</p> <ul><li><code>/app/gunicorn_conf.py</code></li> <li><code>/app/app/gunicorn_conf.py</code></li> <li><code>/gunicorn_conf.py</code></li></ul> <h2 id="custom-app-prestart-sh"><a href="#custom-app-prestart-sh" class="header-anchor">#</a> Custom  <code>/app/prestart.sh</code></h2> <p>app 시작 전, 필요한 작업을 스크립트 처리할 수도 있다. 많이 사용 예로는 Alembic을 이용한 SQL migration 역시도 가능하다.</p> <p>예를 들어, 아래와 같은 스크립트를 <code>./app/prestart.sh</code> 에 만든다. (혹은 <code>PRE_START_PATH</code>로 위치를 변수로 넘겨 줄 수도 있다.)</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#! /usr/bin/env bash</span>

<span class="token comment"># Let the DB start</span>
<span class="token function">sleep</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment"># Run migrations</span>
alembic upgrade <span class="token function">head</span>
</code></pre></div><p>(대략 DB 뜨는 시간)10초를 기다린 후, alembic 커맨드를 실행한다. 그 후 앱이 구동 된다.</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><a href="https://github.com/tiangolo/uvicorn-gunicorn-docker" target="_blank" rel="noopener noreferrer">https://github.com/tiangolo/uvicorn-gunicorn-docker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://fastapi.tiangolo.com/deployment/docker/" target="_blank" rel="noopener noreferrer">https://fastapi.tiangolo.com/deployment/docker/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#쓰면-좋은-경우" title="쓰면 좋은 경우">쓰면 좋은 경우</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#안-써도-되는-경우-prod-배포의-경우" title="안 써도 되는 경우 (Prod 배포의 경우)">안 써도 되는 경우 (Prod 배포의 경우)</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#사용-방법" title="사용 방법">사용 방법</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#다른-dependency들과-함께-docker-compose로-실행하기" title="다른 dependency들과 함께 Docker Compose로 실행하기">다른 dependency들과 함께 Docker Compose로 실행하기</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#환경변수" title="환경변수">환경변수</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#custom-gunicorn-설정-파일" title="Custom Gunicorn 설정 파일">Custom Gunicorn 설정 파일</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#custom-app-prestart-sh" title="Custom  /app/prestart.sh">Custom  /app/prestart.sh</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#references" title="References">References</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/jiyeonseo" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="https://twitter.com/seojeee" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-3d9deeb8><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>Copyright © Jiyeon Seo 2020</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ca882463.js" defer></script><script src="/assets/js/4.d48376ce.js" defer></script><script src="/assets/js/1.a7328d07.js" defer></script><script src="/assets/js/115.013a015b.js" defer></script>
  </body>
</html>
