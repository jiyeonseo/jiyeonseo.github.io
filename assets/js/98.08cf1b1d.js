(window.webpackJsonp=window.webpackJsonp||[]).push([[98],{515:function(t,e,s){"use strict";s.r(e);var a=s(5),n=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"flask에서-runtimeerror-working-outside-of-request-context"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flask에서-runtimeerror-working-outside-of-request-context"}},[t._v("#")]),t._v(" Flask에서 RuntimeError: Working outside of request context.")]),t._v(" "),e("p",[t._v("Flask 쓰다가 삽질을 너무 쎄게 해서 잊지 않기 위해 글로 남겨둔다.")]),t._v(" "),e("p",[t._v("Flask + Celery 조합으로 비동기 처리를 하던중 다음과 같은 에러메세지가 떴다.")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("RuntimeError: Working outside of request context.\n\nThis typically means that you attempted to use functionality that\nneeded an active HTTP request. Consult the documentation on testing\nfor information about how to avoid this problem.\n")])])]),e("p",[t._v("(어디서 났는지 코드라인을 정확하게 알려주면 좋을텐데 ㅠ)")]),t._v(" "),e("p",[t._v("에러 메시지를 읽어보면 active한 HTTP 요청을 필요로 하는 기능을 사용하려 했고 이때문에 에러가 발생한 케이스이다.")]),t._v(" "),e("p",[t._v("나의 경우, Celery를 통해 시작된 Task가 실행된 코드 내에서 발생한 것이 였기에 HTTP 요청이 없는 것이 맞고, 다만 내가 언뜻 보기에는 따로 처리하는 부분이 없어서 코드를 하나 하나 뒤져가며 디버깅을 했다.")]),t._v(" "),e("p",[t._v("결론 먼저 이야기하자면, "),e("code",[t._v("Task")]),t._v(" 안에서 생성하는 "),e("code",[t._v("class")]),t._v("의 "),e("code",[t._v("__init__")]),t._v(" 안에서 다른 Util성 Class 객체를 가져오는 부분이 있었고, 그 내부에서 "),e("code",[t._v("request")]),t._v("의 "),e("code",[t._v("header")]),t._v("를 가져와서 체크하는 로직이 들어있었다. 타고 타고 계속 들어가야 하는 부분이여서 찾아내는데 꽤 오래 걸렸다.")]),t._v(" "),e("p",[t._v("이렇게 열심히 디버깅을 하고 나서 ㅠㅠ 나중에 공식문서에서 이에 대한 힌트를 주고 있는 것을 확인했다.")]),t._v(" "),e("blockquote",[e("p",[t._v("If you try to access "),e("a",{attrs:{href:"https://flask.palletsprojects.com/en/2.0.x/api/#flask.request",target:"_blank",rel:"noopener noreferrer"}},[t._v("request"),e("OutboundLink")],1),t._v(", or anything that uses it, outside a request context, you’ll get this error message:")]),t._v(" "),e("p",[t._v("This should typically only happen when testing code that expects an active request. One option is to use the "),e("a",{attrs:{href:"https://flask.palletsprojects.com/en/2.0.x/api/#flask.Flask.test_client",target:"_blank",rel:"noopener noreferrer"}},[t._v("test client"),e("OutboundLink")],1),t._v(" to simulate a full request. Or you can use "),e("a",{attrs:{href:"https://flask.palletsprojects.com/en/2.0.x/api/#flask.Flask.test_request_context",target:"_blank",rel:"noopener noreferrer"}},[t._v("test_request_context()"),e("OutboundLink")],1),t._v(" in a with block, and everything that runs in the block will have access to request, populated with your test data.")]),t._v(" "),e("p",[t._v("If you see that error somewhere else in your code not related to testing, it most likely indicates that you should move that code into a view function.")])]),t._v(" "),e("p",[t._v("("),e("a",{attrs:{href:"https://flask.palletsprojects.com/en/2.0.x/reqcontext/#manually-push-a-context",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://flask.palletsprojects.com/en/2.0.x/reqcontext/#manually-push-a-context"),e("OutboundLink")],1),t._v(")")]),t._v(" "),e("p",[t._v("이를 정리해보면...")]),t._v(" "),e("p",[t._v("위의 에러 메세지를 보았을 때,")]),t._v(" "),e("ul",[e("li",[t._v("코드 안에서 "),e("a",{attrs:{href:"https://flask.palletsprojects.com/en/2.0.x/api/#flask.request",target:"_blank",rel:"noopener noreferrer"}},[t._v("request"),e("OutboundLink")],1),t._v("를 부르고 있는지를 먼저 체크해 볼 것.\n"),e("ul",[e("li",[t._v("왠만하면 view function으로 코드 옮기기")])])])]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" flask "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" request "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 요걸로 찾아보자")]),t._v("\n")])])]),e("ul",[e("li",[t._v("만약 테스트 코드 안에서 발생한다면...\n"),e("ul",[e("li",[e("a",{attrs:{href:"https://flask.palletsprojects.com/en/2.0.x/api/#flask.Flask.test_client",target:"_blank",rel:"noopener noreferrer"}},[t._v("test client"),e("OutboundLink")],1),t._v("를 사용해서 요청을 만들거나")]),t._v(" "),e("li",[e("code",[t._v("with")]),t._v(" 블락과 함께 "),e("a",{attrs:{href:"https://flask.palletsprojects.com/en/2.0.x/api/#flask.Flask.test_request_context",target:"_blank",rel:"noopener noreferrer"}},[t._v("test_request_context"),e("OutboundLink")],1),t._v("를 아래와 같이 사용하거나")])])])]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("generate_report")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("year"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("args"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'format'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test_request_context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/make_report/2017'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'format'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'short'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    generate_report"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v('에러 메세지에서도 이미 이야기 해주고 있는데, "내 코드에서는 request 안 찾는데?" 라고 굳게 믿어버리고 돌아 돌아 문제를 발견했다. 에러 메세지 속 request가 '),e("code",[t._v("from flask import request")]),t._v(" 거라고 생각도 못했다. (왜그래쓰까)")]),t._v(" "),e("p",[t._v("에러 메세지, 그리고 공식 문서 꼼꼼히 읽는 것은 항상 중요하다.")])])}),[],!1,null,null,null);e.default=n.exports}}]);